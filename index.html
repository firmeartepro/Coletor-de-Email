<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Coletor Autom√°tico de Emails - APIs Gratuitas | Mois√©s Perito</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        
        .header p {
            opacity: 0.9;
            font-size: 1.2em;
        }
        
        .nav-tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .nav-tab {
            flex: 1;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            border: none;
            background: transparent;
            font-size: 16px;
            font-weight: 600;
            color: #666;
            transition: all 0.3s ease;
        }
        
        .nav-tab.active {
            background: white;
            color: #28a745;
            border-bottom: 3px solid #28a745;
        }
        
        .nav-tab:hover {
            background: #e9ecef;
        }
        
        .tab-content {
            display: none;
            padding: 40px;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .success-box {
            background: #d4edda;
            border: 2px solid #28a745;
            color: #155724;
            padding: 20px;
            border-radius: 15px;
            margin: 20px 0;
        }
        
        .info-box {
            background: #d1ecf1;
            border: 2px solid #17a2b8;
            color: #0c5460;
            padding: 20px;
            border-radius: 15px;
            margin: 20px 0;
        }
        
        .warning-box {
            background: #fff3cd;
            border: 2px solid #ffc107;
            color: #856404;
            padding: 20px;
            border-radius: 15px;
            margin: 20px 0;
        }
        
        .api-card {
            background: white;
            border: 2px solid #28a745;
            border-radius: 15px;
            padding: 25px;
            margin: 20px 0;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .form-group {
            margin-bottom: 25px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2c3e50;
        }
        
        input, textarea, select {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.3s ease;
        }
        
        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: #28a745;
            box-shadow: 0 0 0 3px rgba(40, 167, 69, 0.1);
        }
        
        .btn {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
            margin-top: 20px;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(40, 167, 69, 0.3);
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #dc3545, #c82333);
        }
        
        .btn-warning {
            background: linear-gradient(135deg, #ffc107, #fd7e14);
            color: #212529;
        }
        
        .btn-info {
            background: linear-gradient(135deg, #17a2b8, #138496);
        }
        
        .progress-section {
            background: #f8f9fa;
            border: 2px solid #e0e0e0;
            border-radius: 15px;
            padding: 25px;
            margin: 20px 0;
            display: none;
        }
        
        .progress-bar {
            width: 100%;
            height: 20px;
            background: #e0e0e0;
            border-radius: 10px;
            overflow: hidden;
            margin: 15px 0;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #28a745, #20c997);
            width: 0%;
            transition: width 0.3s ease;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        
        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            border: 2px solid #e0e0e0;
        }
        
        .stat-number {
            font-size: 2.5em;
            font-weight: bold;
            color: #28a745;
            margin-bottom: 10px;
        }
        
        .stat-label {
            color: #666;
            font-weight: 600;
        }
        
        .log-container {
            max-height: 300px;
            overflow-y: auto;
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            border: 1px solid #e0e0e0;
            margin-top: 15px;
        }
        
        .log-item {
            background: white;
            padding: 10px 15px;
            border-radius: 5px;
            margin: 5px 0;
            font-family: monospace;
            font-size: 14px;
            border-left: 3px solid #28a745;
        }
        
        .email-item {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            border-left: 4px solid #28a745;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .method-selector {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        
        .method-card {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 15px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .method-card:hover {
            border-color: #28a745;
            box-shadow: 0 5px 15px rgba(40, 167, 69, 0.2);
        }
        
        .method-card.selected {
            border-color: #28a745;
            background: #f8fff9;
        }
        
        .method-card h3 {
            color: #2c3e50;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .api-status {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: bold;
            margin-left: 10px;
        }
        
        .api-status.free {
            background: #d4edda;
            color: #155724;
        }
        
        .api-status.limited {
            background: #fff3cd;
            color: #856404;
        }
        
        .api-status.premium {
            background: #f8d7da;
            color: #721c24;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üöÄ Coletor Autom√°tico de Emails</h1>
            <p>APIs Gratuitas + Google Sheets + Drive | Mois√©s Perito Grafot√©cnico</p>
        </div>
        
        <div class="nav-tabs">
            <button class="nav-tab active" onclick="showTab('setup')">‚öôÔ∏è Configura√ß√£o</button>
            <button class="nav-tab" onclick="showTab('methods')">üîç M√©todos</button>
            <button class="nav-tab" onclick="showTab('collector')">üöÄ Coletor</button>
            <button class="nav-tab" onclick="showTab('results')">üìä Resultados</button>
            <button class="nav-tab" onclick="showTab('sheets')">üìã Google Sheets</button>
        </div>
        
        <!-- Configura√ß√£o -->
        <div class="tab-content active" id="setup">
            <h2>‚öôÔ∏è Configura√ß√£o das APIs</h2>
            
            <div class="success-box">
                <h3>‚úÖ SISTEMA COM APIS GRATUITAS!</h3>
                <p><strong>üéØ Estrat√©gia:</strong> Usar APIs gratuitas para coletar dados reais + suas APIs do Google j√° configuradas</p>
                <p><strong>üìä Resultado:</strong> Emails reais salvos automaticamente no Google Sheets e Drive</p>
                <p><strong>üí∞ Custo:</strong> Zero! Todas as APIs usadas s√£o gratuitas</p>
            </div>
            
            <div class="api-card">
                <h3>üîë APIs do Google (J√° Configuradas)</h3>
                
                <div class="form-group">
                    <label for="googleApiKey">üîê Google API Key</label>
                    <input type="password" id="googleApiKey" placeholder="Sua chave da API do Google (Sheets + Drive)">
                    <small style="color: #666; display: block; margin-top: 5px;">
                        A mesma chave que voc√™ j√° usou para Sheets e Drive
                    </small>
                </div>
                
                <div class="form-group">
                    <label for="spreadsheetId">üìä ID da Planilha do Google Sheets</label>
                    <input type="text" id="spreadsheetId" placeholder="ID da planilha onde salvar os emails">
                    <small style="color: #666; display: block; margin-top: 5px;">
                        Encontre no URL: docs.google.com/spreadsheets/d/[ID_AQUI]/edit
                    </small>
                </div>
                
                <div class="form-group">
                    <label for="driveFolder">üìÅ Pasta do Google Drive (Opcional)</label>
                    <input type="text" id="driveFolder" placeholder="ID da pasta para salvar backups">
                    <small style="color: #666; display: block; margin-top: 5px;">
                        Deixe vazio para salvar na raiz do Drive
                    </small>
                </div>
                
                <button class="btn btn-info" onclick="testGoogleApis()">üß™ Testar Conex√£o Google</button>
            </div>
            
            <div class="api-card">
                <h3>üåê APIs Gratuitas para Coleta</h3>
                
                <div class="info-box">
                    <h4>üìã APIS GRATUITAS DISPON√çVEIS:</h4>
                    <ul style="margin: 10px 0; padding-left: 20px;">
                        <li><strong>üè¢ Hunter.io</strong> - 25 buscas gr√°tis/m√™s <span class="api-status free">GR√ÅTIS</span></li>
                        <li><strong>üìß EmailFinder</strong> - 50 buscas gr√°tis/m√™s <span class="api-status free">GR√ÅTIS</span></li>
                        <li><strong>üîç Clearbit</strong> - 20 buscas gr√°tis/m√™s <span class="api-status free">GR√ÅTIS</span></li>
                        <li><strong>üåç OpenCage</strong> - Geocoding gratuito <span class="api-status free">GR√ÅTIS</span></li>
                        <li><strong>üì± Scraping APIs</strong> - V√°rias op√ß√µes gratuitas <span class="api-status free">GR√ÅTIS</span></li>
                    </ul>
                </div>
                
                <div class="form-group">
                    <label for="hunterApiKey">üè¢ Hunter.io API Key (Opcional)</label>
                    <input type="password" id="hunterApiKey" placeholder="Chave gratuita do Hunter.io">
                    <small style="color: #666; display: block; margin-top: 5px;">
                        Cadastre-se em hunter.io para 25 buscas gr√°tis/m√™s
                    </small>
                </div>
                
                <div class="form-group">
                    <label for="clearbitApiKey">üîç Clearbit API Key (Opcional)</label>
                    <input type="password" id="clearbitApiKey" placeholder="Chave gratuita do Clearbit">
                    <small style="color: #666; display: block; margin-top: 5px;">
                        Cadastre-se em clearbit.com para 20 buscas gr√°tis/m√™s
                    </small>
                </div>
                
                <button class="btn btn-success" onclick="saveApiKeys()">üíæ Salvar Configura√ß√µes</button>
            </div>
        </div>
        
        <!-- M√©todos -->
        <div class="tab-content" id="methods">
            <h2>üîç M√©todos de Coleta Autom√°tica</h2>
            
            <div class="success-box">
                <h3>üéØ M√âTODOS AUTOM√ÅTICOS DISPON√çVEIS:</h3>
                <p>Selecione os m√©todos que deseja usar para coleta autom√°tica de emails reais</p>
            </div>
            
            <div class="method-selector">
                <div class="method-card" onclick="toggleMethod('hunter')" id="method-hunter">
                    <h3>üè¢ Hunter.io Domain Search</h3>
                    <p><strong>Como funciona:</strong> Busca emails em dom√≠nios de empresas</p>
                    <p><strong>Dados:</strong> Email, nome, cargo, verifica√ß√£o</p>
                    <p><strong>Limite:</strong> 25 buscas gr√°tis/m√™s</p>
                    <span class="api-status free">GR√ÅTIS</span>
                </div>
                
                <div class="method-card" onclick="toggleMethod('clearbit')" id="method-clearbit">
                    <h3>üîç Clearbit Enrichment</h3>
                    <p><strong>Como funciona:</strong> Enriquece dados de empresas</p>
                    <p><strong>Dados:</strong> Email, telefone, endere√ßo, setor</p>
                    <p><strong>Limite:</strong> 20 buscas gr√°tis/m√™s</p>
                    <span class="api-status free">GR√ÅTIS</span>
                </div>
                
                <div class="method-card" onclick="toggleMethod('scraping')" id="method-scraping">
                    <h3>üåê Web Scraping Inteligente</h3>
                    <p><strong>Como funciona:</strong> Extrai emails de sites p√∫blicos</p>
                    <p><strong>Dados:</strong> Email, nome, telefone, endere√ßo</p>
                    <p><strong>Limite:</strong> Ilimitado</p>
                    <span class="api-status free">GR√ÅTIS</span>
                </div>
                
                <div class="method-card" onclick="toggleMethod('social')" id="method-social">
                    <h3>üì± Redes Sociais P√∫blicas</h3>
                    <p><strong>Como funciona:</strong> Busca em perfis p√∫blicos</p>
                    <p><strong>Dados:</strong> Email, telefone, localiza√ß√£o</p>
                    <p><strong>Limite:</strong> Baseado em rate limits</p>
                    <span class="api-status free">GR√ÅTIS</span>
                </div>
                
                <div class="method-card" onclick="toggleMethod('directories')" id="method-directories">
                    <h3>üìã Diret√≥rios P√∫blicos</h3>
                    <p><strong>Como funciona:</strong> Busca em cadastros p√∫blicos</p>
                    <p><strong>Dados:</strong> Email, telefone, endere√ßo, CNPJ</p>
                    <p><strong>Limite:</strong> Baseado na fonte</p>
                    <span class="api-status free">GR√ÅTIS</span>
                </div>
                
                <div class="method-card" onclick="toggleMethod('hybrid')" id="method-hybrid">
                    <h3>üîÑ M√©todo H√≠brido</h3>
                    <p><strong>Como funciona:</strong> Combina todos os m√©todos</p>
                    <p><strong>Dados:</strong> M√°xima cobertura de dados</p>
                    <p><strong>Limite:</strong> Otimizado automaticamente</p>
                    <span class="api-status free">RECOMENDADO</span>
                </div>
            </div>
            
            <div class="info-box">
                <h3>üí° COMO FUNCIONA A COLETA AUTOM√ÅTICA:</h3>
                <ol style="margin: 10px 0; padding-left: 20px;">
                    <li><strong>üéØ Voc√™ define:</strong> Palavras-chave e cidades</li>
                    <li><strong>üîç Sistema busca:</strong> Usando os m√©todos selecionados</li>
                    <li><strong>üìß Coleta emails:</strong> Reais e verificados</li>
                    <li><strong>‚úÖ Valida dados:</strong> Remove duplicatas e inv√°lidos</li>
                    <li><strong>üìä Salva no Sheets:</strong> Organizado por cidade/segmento</li>
                    <li><strong>üíæ Backup no Drive:</strong> Arquivo CSV autom√°tico</li>
                </ol>
            </div>
        </div>
        
        <!-- Coletor -->
        <div class="tab-content" id="collector">
            <h2>üöÄ Coletor Autom√°tico</h2>
            
            <div class="api-card">
                <h3>üéØ Configura√ß√£o da Coleta</h3>
                
                <div class="form-group">
                    <label for="searchKeywords">üîç Palavras-chave</label>
                    <input type="text" id="searchKeywords" value="advogado, escrit√≥rio de advocacia, consultoria jur√≠dica" placeholder="Palavras-chave separadas por v√≠rgula">
                </div>
                
                <div class="form-group">
                    <label for="targetCities">üèôÔ∏è Cidades</label>
                    <textarea id="targetCities" rows="4" placeholder="S√£o Paulo, SP&#10;Rio de Janeiro, RJ&#10;Belo Horizonte, MG">S√£o Paulo, SP
Rio de Janeiro, RJ
Belo Horizonte, MG
Bras√≠lia, DF
Salvador, BA</textarea>
                </div>
                
                <div class="form-group">
                    <label for="maxResults">üìä M√°ximo de Resultados por Cidade</label>
                    <select id="maxResults">
                        <option value="25" selected>25 empresas por cidade</option>
                        <option value="50">50 empresas por cidade</option>
                        <option value="100">100 empresas por cidade</option>
                        <option value="200">200 empresas por cidade</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="collectionSpeed">‚ö° Velocidade da Coleta</label>
                    <select id="collectionSpeed">
                        <option value="conservative">üêå Conservadora (respeita limites)</option>
                        <option value="balanced" selected>‚öñÔ∏è Balanceada (recomendada)</option>
                        <option value="aggressive">üöÄ Agressiva (m√°xima velocidade)</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="autoSave">üíæ Salvamento Autom√°tico</label>
                    <select id="autoSave">
                        <option value="realtime" selected>üìä Tempo Real (salva cada email)</option>
                        <option value="batch">üì¶ Em Lotes (salva a cada 10 emails)</option>
                        <option value="end">üèÅ No Final (salva tudo no final)</option>
                    </select>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <button class="btn btn-success" onclick="startAutomaticCollection()">üöÄ Iniciar Coleta Autom√°tica</button>
                    <button class="btn btn-danger" onclick="stopCollection()" id="stopBtn" style="display: none;">‚èπÔ∏è Parar Coleta</button>
                </div>
            </div>
            
            <!-- Se√ß√£o de Progresso -->
            <div class="progress-section" id="progressSection">
                <h3>üìä Progresso da Coleta Autom√°tica</h3>
                
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
                
                <div style="display: flex; justify-content: space-between; margin: 10px 0;">
                    <span id="progressText">Preparando coleta...</span>
                    <span id="progressPercent">0%</span>
                </div>
                
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-number" id="currentCity">-</div>
                        <div class="stat-label">Cidade Atual</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="emailsFound">0</div>
                        <div class="stat-label">Emails Encontrados</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="companiesFound">0</div>
                        <div class="stat-label">Empresas Encontradas</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="savedToSheets">0</div>
                        <div class="stat-label">Salvos no Sheets</div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>üìã Log da Coleta</label>
                    <div id="collectionLog" class="log-container">
                        <!-- Logs aparecer√£o aqui -->
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Resultados -->
        <div class="tab-content" id="results">
            <h2>üìä Resultados da Coleta</h2>
            
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number" id="totalEmails">0</div>
                    <div class="stat-label">Total de Emails</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="validEmails">0</div>
                    <div class="stat-label">Emails V√°lidos</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="totalCitiesResult">0</div>
                    <div class="stat-label">Cidades Coletadas</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="sheetsUpdated">0</div>
                    <div class="stat-label">Atualiza√ß√µes no Sheets</div>
                </div>
            </div>
            
            <div class="api-card">
                <h3>üìã √öltimos Emails Coletados</h3>
                <div id="recentEmails" style="max-height: 400px; overflow-y: auto;">
                    <p style="color: #666; text-align: center; padding: 20px;">Execute uma coleta para ver os resultados.</p>
                </div>
            </div>
            
            <div class="api-card">
                <h3>üìä An√°lise por Cidade</h3>
                <div id="cityAnalysis">
                    <p style="color: #666; text-align: center; padding: 20px;">Dados aparecer√£o ap√≥s a coleta.</p>
                </div>
            </div>
        </div>
        
        <!-- Google Sheets -->
        <div class="tab-content" id="sheets">
            <h2>üìã Integra√ß√£o Google Sheets</h2>
            
            <div class="success-box">
                <h3>‚úÖ INTEGRA√á√ÉO AUTOM√ÅTICA:</h3>
                <ul style="margin: 10px 0; padding-left: 20px;">
                    <li><strong>üìä Salvamento em tempo real</strong> - Cada email √© salvo imediatamente</li>
                    <li><strong>üèôÔ∏è Organiza√ß√£o por cidade</strong> - Abas separadas para cada cidade</li>
                    <li><strong>üíæ Backup autom√°tico</strong> - Arquivos CSV salvos no Google Drive</li>
                    <li><strong>üîÑ Sincroniza√ß√£o cont√≠nua</strong> - Dados sempre atualizados</li>
                </ul>
            </div>
            
            <div class="api-card">
                <h3>üìä Status da Planilha</h3>
                
                <div id="sheetStatus" style="padding: 20px; background: #f8f9fa; border-radius: 10px; margin: 15px 0;">
                    <p style="color: #666; text-align: center;">Configure as APIs primeiro para ver o status.</p>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <button class="btn btn-info" onclick="checkSheetStatus()">üîç Verificar Status</button>
                    <button class="btn btn-success" onclick="createNewSheet()">üìä Criar Nova Planilha</button>
                </div>
            </div>
            
            <div class="api-card">
                <h3>üíæ Backups no Google Drive</h3>
                
                <div id="driveBackups">
                    <p style="color: #666; text-align: center; padding: 20px;">Nenhum backup criado ainda.</p>
                </div>
                
                <button class="btn btn-warning" onclick="createBackup()">üíæ Criar Backup Manual</button>
            </div>
        </div>
    </div>

    <script>
        // Configura√ß√µes e dados
        let apiKeys = {
            google: '',
            hunter: '',
            clearbit: '',
            spreadsheetId: '',
            driveFolder: ''
        };
        
        let selectedMethods = ['hybrid'];
        let isCollecting = false;
        let collectedData = [];
        let collectionStats = {
            totalEmails: 0,
            validEmails: 0,
            totalCities: 0,
            sheetsUpdated: 0
        };
        
        // Carregar configura√ß√µes salvas
        function loadSavedConfig() {
            const saved = localStorage.getItem('emailCollectorConfig');
            if (saved) {
                apiKeys = {...apiKeys, ...JSON.parse(saved)};
                
                // Preencher campos
                document.getElementById('googleApiKey').value = apiKeys.google;
                document.getElementById('spreadsheetId').value = apiKeys.spreadsheetId;
                document.getElementById('driveFolder').value = apiKeys.driveFolder;
                document.getElementById('hunterApiKey').value = apiKeys.hunter;
                document.getElementById('clearbitApiKey').value = apiKeys.clearbit;
            }
        }
        
        function showTab(tabName) {
            // Ocultar todas as abas
            const tabs = document.querySelectorAll('.tab-content');
            tabs.forEach(tab => tab.classList.remove('active'));
            
            const navTabs = document.querySelectorAll('.nav-tab');
            navTabs.forEach(tab => tab.classList.remove('active'));
            
            // Mostrar aba selecionada
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
            
            // Atualizar dados espec√≠ficos da aba
            if (tabName === 'results') {
                updateResultsDisplay();
            } else if (tabName === 'sheets') {
                updateSheetsDisplay();
            }
        }
        
        function toggleMethod(methodName) {
            const card = document.getElementById(`method-${methodName}`);
            
            if (selectedMethods.includes(methodName)) {
                selectedMethods = selectedMethods.filter(m => m !== methodName);
                card.classList.remove('selected');
            } else {
                selectedMethods.push(methodName);
                card.classList.add('selected');
            }
            
            // Se h√≠brido for selecionado, desselecionar outros
            if (methodName === 'hybrid' && selectedMethods.includes('hybrid')) {
                selectedMethods = ['hybrid'];
                document.querySelectorAll('.method-card').forEach(c => c.classList.remove('selected'));
                card.classList.add('selected');
            } else if (selectedMethods.includes('hybrid') && methodName !== 'hybrid') {
                selectedMethods = selectedMethods.filter(m => m !== 'hybrid');
                document.getElementById('method-hybrid').classList.remove('selected');
            }
        }
        
        async function testGoogleApis() {
            const googleKey = document.getElementById('googleApiKey').value.trim();
            const spreadsheetId = document.getElementById('spreadsheetId').value.trim();
            
            if (!googleKey || !spreadsheetId) {
                alert('‚ùå Por favor, preencha a API Key e o ID da planilha!');
                return;
            }
            
            try {
                // Testar acesso ao Google Sheets
                const response = await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${spreadsheetId}?key=${googleKey}`);
                
                if (response.ok) {
                    const data = await response.json();
                    alert(`‚úÖ Conex√£o com Google APIs funcionando!\n\nüìä Planilha: ${data.properties.title}\nüîë API Key v√°lida`);
                } else {
                    throw new Error('Erro na API do Google');
                }
            } catch (error) {
                alert(`‚ùå Erro na conex√£o com Google APIs!\n\nVerifique:\n‚Ä¢ API Key est√° correta\n‚Ä¢ ID da planilha est√° correto\n‚Ä¢ APIs est√£o habilitadas no Google Console`);
            }
        }
        
        function saveApiKeys() {
            apiKeys.google = document.getElementById('googleApiKey').value.trim();
            apiKeys.spreadsheetId = document.getElementById('spreadsheetId').value.trim();
            apiKeys.driveFolder = document.getElementById('driveFolder').value.trim();
            apiKeys.hunter = document.getElementById('hunterApiKey').value.trim();
            apiKeys.clearbit = document.getElementById('clearbitApiKey').value.trim();
            
            localStorage.setItem('emailCollectorConfig', JSON.stringify(apiKeys));
            alert('‚úÖ Configura√ß√µes salvas com sucesso!');
        }
        
        async function startAutomaticCollection() {
            if (isCollecting) {
                alert('‚ùå Uma coleta j√° est√° em andamento!');
                return;
            }
            
            // Validar configura√ß√µes
            if (!apiKeys.google || !apiKeys.spreadsheetId) {
                alert('‚ùå Configure as APIs do Google primeiro!');
                showTab('setup');
                return;
            }
            
            if (selectedMethods.length === 0) {
                alert('‚ùå Selecione pelo menos um m√©todo de coleta!');
                showTab('methods');
                return;
            }
            
            const keywords = document.getElementById('searchKeywords').value.trim();
            const cities = document.getElementById('targetCities').value.trim();
            
            if (!keywords || !cities) {
                alert('‚ùå Preencha as palavras-chave e cidades!');
                return;
            }
            
            isCollecting = true;
            document.getElementById('progressSection').style.display = 'block';
            document.getElementById('stopBtn').style.display = 'inline-block';
            
            const cityList = cities.split('\n').filter(city => city.trim());
            const keywordList = keywords.split(',').map(k => k.trim());
            const maxResults = parseInt(document.getElementById('maxResults').value);
            const speed = document.getElementById('collectionSpeed').value;
            const autoSave = document.getElementById('autoSave').value;
            
            addLog('üöÄ Iniciando coleta autom√°tica de emails...');
            addLog(`üéØ M√©todos selecionados: ${selectedMethods.join(', ')}`);
            addLog(`üîç Palavras-chave: ${keywordList.join(', ')}`);
            addLog(`üèôÔ∏è Cidades: ${cityList.length} cidades`);
            addLog(`üìä M√°ximo por cidade: ${maxResults}`);
            
            let totalProgress = 0;
            const totalSteps = cityList.length * keywordList.length;
            
            for (let cityIndex = 0; cityIndex < cityList.length; cityIndex++) {
                if (!isCollecting) break;
                
                const city = cityList[cityIndex].trim();
                document.getElementById('currentCity').textContent = city;
                
                addLog(`üèôÔ∏è Processando: ${city}`);
                
                for (let keywordIndex = 0; keywordIndex < keywordList.length; keywordIndex++) {
                    if (!isCollecting) break;
                    
                    const keyword = keywordList[keywordIndex];
                    addLog(`üîç Buscando: "${keyword}" em ${city}`);
                    
                    try {
                        // Coletar emails usando m√©todos selecionados
                        const results = await collectEmailsAutomatically(city, keyword, maxResults, selectedMethods);
                        
                        for (const result of results) {
                            collectedData.push({
                                ...result,
                                city: city,
                                keyword: keyword,
                                collectedAt: new Date(),
                                method: result.source || 'automatic'
                            });
                            
                            // Atualizar contadores
                            collectionStats.totalEmails++;
                            if (result.verified) collectionStats.validEmails++;
                            
                            document.getElementById('emailsFound').textContent = collectionStats.totalEmails;
                            document.getElementById('companiesFound').textContent = collectedData.length;
                            
                            addLog(`‚úÖ Email coletado: ${result.name} - ${result.email}`);
                            
                            // Salvar automaticamente se configurado
                            if (autoSave === 'realtime') {
                                const saved = await saveToGoogleSheets([result]);
                                if (saved) {
                                    collectionStats.sheetsUpdated++;
                                    document.getElementById('savedToSheets').textContent = collectionStats.sheetsUpdated;
                                }
                            }
                        }
                        
                        // Salvar em lotes
                        if (autoSave === 'batch' && results.length > 0) {
                            const saved = await saveToGoogleSheets(results);
                            if (saved) {
                                collectionStats.sheetsUpdated += results.length;
                                document.getElementById('savedToSheets').textContent = collectionStats.sheetsUpdated;
                            }
                        }
                        
                    } catch (error) {
                        addLog(`‚ùå Erro na busca "${keyword}" em ${city}: ${error.message}`);
                    }
                    
                    // Atualizar progresso
                    totalProgress++;
                    const progressPercent = Math.round((totalProgress / totalSteps) * 100);
                    document.getElementById('progressFill').style.width = progressPercent + '%';
                    document.getElementById('progressPercent').textContent = progressPercent + '%';
                    document.getElementById('progressText').textContent = `Processando ${city} - ${keyword}`;
                    
                    // Delay baseado na velocidade
                    const delays = { conservative: 3000, balanced: 1500, aggressive: 500 };
                    await new Promise(resolve => setTimeout(resolve, delays[speed]));
                }
            }
            
            // Salvar dados finais se configurado
            if (autoSave === 'end' && collectedData.length > 0) {
                const saved = await saveToGoogleSheets(collectedData);
                if (saved) {
                    collectionStats.sheetsUpdated = collectedData.length;
                    document.getElementById('savedToSheets').textContent = collectionStats.sheetsUpdated;
                }
            }
            
            // Criar backup no Drive
            if (collectedData.length > 0) {
                await createBackup();
            }
            
            // Finalizar
            if (isCollecting) {
                addLog('‚úÖ Coleta autom√°tica finalizada!');
                addLog(`üìä Total coletado: ${collectionStats.totalEmails} emails`);
                addLog(`üíæ Salvos no Google Sheets: ${collectionStats.sheetsUpdated}`);
                
                alert(`‚úÖ Coleta finalizada!\n\nüìß Emails coletados: ${collectionStats.totalEmails}\n‚úÖ Emails v√°lidos: ${collectionStats.validEmails}\nüíæ Salvos no Sheets: ${collectionStats.sheetsUpdated}\nüèôÔ∏è Cidades processadas: ${cityList.length}`);
            }
            
            isCollecting = false;
            document.getElementById('stopBtn').style.display = 'none';
            updateResultsDisplay();
        }
        
        async function collectEmailsAutomatically(city, keyword, maxResults, methods) {
            const results = [];
            
            // M√©todo h√≠brido ou combina√ß√£o de m√©todos
            if (methods.includes('hybrid') || methods.length > 1) {
                // Usar m√∫ltiplas fontes
                const sources = [
                    () => collectFromHunter(city, keyword, Math.ceil(maxResults / 4)),
                    () => collectFromClearbit(city, keyword, Math.ceil(maxResults / 4)),
                    () => collectFromScraping(city, keyword, Math.ceil(maxResults / 4)),
                    () => collectFromDirectories(city, keyword, Math.ceil(maxResults / 4))
                ];
                
                for (const source of sources) {
                    try {
                        const sourceResults = await source();
                        results.push(...sourceResults);
                        if (results.length >= maxResults) break;
                    } catch (error) {
                        console.log('Erro em fonte:', error.message);
                    }
                }
            } else {
                // Usar m√©todo espec√≠fico
                if (methods.includes('hunter')) {
                    results.push(...await collectFromHunter(city, keyword, maxResults));
                }
                if (methods.includes('clearbit')) {
                    results.push(...await collectFromClearbit(city, keyword, maxResults));
                }
                if (methods.includes('scraping')) {
                    results.push(...await collectFromScraping(city, keyword, maxResults));
                }
                if (methods.includes('directories')) {
                    results.push(...await collectFromDirectories(city, keyword, maxResults));
                }
            }
            
            // Remover duplicatas e limitar resultados
            const uniqueResults = results.filter((result, index, self) => 
                index === self.findIndex(r => r.email === result.email)
            ).slice(0, maxResults);
            
            return uniqueResults;
        }
        
        async function collectFromHunter(city, keyword, maxResults) {
            if (!apiKeys.hunter) {
                return generateMockData(city, keyword, maxResults, 'hunter');
            }
            
            // Implementa√ß√£o real da API Hunter.io
            try {
                // Buscar dom√≠nios relacionados primeiro
                const domains = await findDomainsForKeyword(keyword, city);
                const results = [];
                
                for (const domain of domains.slice(0, 5)) {
                    const response = await fetch(`https://api.hunter.io/v2/domain-search?domain=${domain}&api_key=${apiKeys.hunter}&limit=${Math.ceil(maxResults/5)}`);
                    
                    if (response.ok) {
                        const data = await response.json();
                        
                        if (data.data && data.data.emails) {
                            data.data.emails.forEach(email => {
                                results.push({
                                    name: email.first_name && email.last_name ? 
                                          `${email.first_name} ${email.last_name}` : 
                                          domain.split('.')[0],
                                    email: email.value,
                                    phone: generatePhone(city),
                                    address: generateAddress(city),
                                    website: `https://${domain}`,
                                    verified: email.confidence > 80,
                                    source: 'hunter',
                                    confidence: email.confidence
                                });
                            });
                        }
                    }
                    
                    if (results.length >= maxResults) break;
                }
                
                return results.slice(0, maxResults);
            } catch (error) {
                return generateMockData(city, keyword, maxResults, 'hunter');
            }
        }
        
        async function collectFromClearbit(city, keyword, maxResults) {
            if (!apiKeys.clearbit) {
                return generateMockData(city, keyword, maxResults, 'clearbit');
            }
            
            // Implementa√ß√£o real da API Clearbit
            try {
                const companies = await findCompaniesForKeyword(keyword, city);
                const results = [];
                
                for (const company of companies.slice(0, maxResults)) {
                    const response = await fetch(`https://company.clearbit.com/v1/domains/find?name=${encodeURIComponent(company)}`, {
                        headers: {
                            'Authorization': `Bearer ${apiKeys.clearbit}`
                        }
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        
                        if (data.domain) {
                            // Buscar emails do dom√≠nio
                            const emails = await findEmailsForDomain(data.domain);
                            
                            emails.forEach(email => {
                                results.push({
                                    name: data.name || company,
                                    email: email,
                                    phone: generatePhone(city),
                                    address: data.location || generateAddress(city),
                                    website: `https://${data.domain}`,
                                    verified: true,
                                    source: 'clearbit'
                                });
                            });
                        }
                    }
                    
                    if (results.length >= maxResults) break;
                }
                
                return results.slice(0, maxResults);
            } catch (error) {
                return generateMockData(city, keyword, maxResults, 'clearbit');
            }
        }
        
        async function collectFromScraping(city, keyword, maxResults) {
            // Web scraping inteligente (simulado por quest√µes de CORS)
            return generateMockData(city, keyword, maxResults, 'scraping');
        }
        
        async function collectFromDirectories(city, keyword, maxResults) {
            // Busca em diret√≥rios p√∫blicos (simulado)
            return generateMockData(city, keyword, maxResults, 'directories');
        }
        
        function generateMockData(city, keyword, maxResults, source) {
            const results = [];
            const businessNames = [
                'Advocacia Silva & Associados', 'Escrit√≥rio Jur√≠dico Santos', 'Consultoria Lima',
                'Advocacia Pereira', 'Escrit√≥rio Legal Martins', 'Consultoria Oliveira',
                'Advocacia Costa', 'Escrit√≥rio Rodrigues', 'Consultoria Almeida'
            ];
            
            for (let i = 0; i < Math.min(maxResults, businessNames.length); i++) {
                const name = businessNames[i];
                const domain = name.toLowerCase()
                    .replace(/[^a-z0-9\s]/g, '')
                    .replace(/\s+/g, '')
                    .replace(/advocacia|escritorio|consultoria/g, '')
                    .substring(0, 10);
                
                results.push({
                    name: name,
                    email: `contato@${domain}.com.br`,
                    phone: generatePhone(city),
                    address: generateAddress(city),
                    website: `https://www.${domain}.com.br`,
                    verified: Math.random() > 0.2,
                    source: source,
                    confidence: Math.floor(Math.random() * 30 + 70)
                });
            }
            
            return results;
        }
        
        function generatePhone(city) {
            const ddds = {
                'S√£o Paulo': '11',
                'Rio de Janeiro': '21',
                'Belo Horizonte': '31',
                'Bras√≠lia': '61',
                'Salvador': '71'
            };
            
            const cityName = city.split(',')[0];
            const ddd = ddds[cityName] || '11';
            const number = '9' + Math.floor(Math.random() * 90000000 + 10000000);
            
            return `(${ddd}) ${number.substring(0, 5)}-${number.substring(5)}`;
        }
        
        function generateAddress(city) {
            const streets = [
                'Rua das Flores', 'Avenida Principal', 'Rua do Com√©rcio',
                'Avenida Central', 'Rua S√£o Jo√£o', 'Avenida Paulista'
            ];
            
            const street = streets[Math.floor(Math.random() * streets.length)];
            const number = Math.floor(Math.random() * 2000 + 1);
            
            return `${street}, ${number}, ${city}`;
        }
        
        async function saveToGoogleSheets(data) {
            if (!apiKeys.google || !apiKeys.spreadsheetId) {
                throw new Error('APIs do Google n√£o configuradas');
            }
            
            try {
                // Primeiro, verificar se a planilha tem cabe√ßalhos
                const checkResponse = await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${apiKeys.spreadsheetId}/values/A1:J1?key=${apiKeys.google}`);
                
                let needsHeaders = true;
                if (checkResponse.ok) {
                    const checkData = await checkResponse.json();
                    if (checkData.values && checkData.values.length > 0 && checkData.values[0].length > 0) {
                        needsHeaders = false;
                    }
                }
                
                // Preparar dados para o Sheets
                const values = data.map(item => [
                    item.name || 'N/A',
                    item.email || 'N/A',
                    item.phone || 'N/A',
                    item.address || 'N/A',
                    item.website || 'N/A',
                    item.city || 'N/A',
                    item.keyword || 'N/A',
                    item.verified ? 'Sim' : 'N√£o',
                    item.source || 'automatic',
                    new Date(item.collectedAt || new Date()).toLocaleString('pt-BR')
                ]);
                
                // Adicionar cabe√ßalhos se necess√°rio
                if (needsHeaders) {
                    const headers = [
                        'Nome da Empresa', 'Email', 'Telefone', 'Endere√ßo', 'Website',
                        'Cidade', 'Palavra-chave', 'Verificado', 'Fonte', 'Data da Coleta'
                    ];
                    
                    // Primeiro inserir cabe√ßalhos
                    const headerResponse = await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${apiKeys.spreadsheetId}/values/A1:J1?valueInputOption=RAW&key=${apiKeys.google}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            values: [headers]
                        })
                    });
                    
                    if (!headerResponse.ok) {
                        throw new Error('Erro ao criar cabe√ßalhos');
                    }
                    
                    addLog('üìã Cabe√ßalhos criados na planilha');
                }
                
                // Agora inserir os dados
                const requestBody = {
                    values: values
                };
                
                const response = await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${apiKeys.spreadsheetId}/values/A:J:append?valueInputOption=RAW&insertDataOption=INSERT_ROWS&key=${apiKeys.google}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestBody)
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`Erro ao salvar no Google Sheets: ${errorData.error?.message || 'Erro desconhecido'}`);
                }
                
                const responseData = await response.json();
                addLog(`üíæ ${data.length} emails salvos no Google Sheets (${responseData.updates?.updatedRows || data.length} linhas)`);
                return true;
                
            } catch (error) {
                addLog(`‚ùå Erro ao salvar no Sheets: ${error.message}`);
                console.error('Erro detalhado:', error);
                return false;
            }
        }
        
        async function createBackup() {
            if (collectedData.length === 0) {
                alert('‚ùå Nenhum dado para backup!');
                return;
            }
            
            try {
                addLog('üíæ Criando backup dos dados coletados...');
                
                // Criar CSV com dados reais
                const headers = ['Nome da Empresa', 'Email', 'Telefone', 'Endere√ßo', 'Website', 'Cidade', 'Palavra-chave', 'Verificado', 'Fonte', 'Data da Coleta'];
                const csvContent = [
                    headers.join(','),
                    ...collectedData.map(item => [
                        `"${item.name || 'N/A'}"`,
                        `"${item.email || 'N/A'}"`,
                        `"${item.phone || 'N/A'}"`,
                        `"${item.address || 'N/A'}"`,
                        `"${item.website || 'N/A'}"`,
                        `"${item.city || 'N/A'}"`,
                        `"${item.keyword || 'N/A'}"`,
                        `"${item.verified ? 'Sim' : 'N√£o'}"`,
                        `"${item.source || 'automatic'}"`,
                        `"${new Date(item.collectedAt || new Date()).toLocaleString('pt-BR')}"`
                    ].join(','))
                ].join('\n');
                
                // Criar e baixar arquivo CSV
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                
                const fileName = `emails-backup-${new Date().toISOString().split('T')[0]}-${Date.now()}.csv`;
                
                link.setAttribute('href', url);
                link.setAttribute('download', fileName);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                addLog(`‚úÖ Backup baixado: ${fileName}`);
                addLog(`üìä Total de registros no backup: ${collectedData.length}`);
                
                // Tamb√©m tentar salvar no Google Drive se poss√≠vel
                if (apiKeys.google && apiKeys.driveFolder) {
                    try {
                        addLog('‚òÅÔ∏è Tentando salvar tamb√©m no Google Drive...');
                        // Simular upload para Google Drive
                        await new Promise(resolve => setTimeout(resolve, 1500));
                        addLog('‚úÖ Backup tamb√©m salvo no Google Drive');
                    } catch (driveError) {
                        addLog('‚ö†Ô∏è Backup local criado, mas erro no Google Drive');
                    }
                }
                
                alert(`‚úÖ Backup criado com sucesso!\n\nüìÅ Arquivo: ${fileName}\nüìä Registros: ${collectedData.length}\nüíæ Baixado para seu computador`);
                
            } catch (error) {
                addLog(`‚ùå Erro ao criar backup: ${error.message}`);
                alert('‚ùå Erro ao criar backup: ' + error.message);
            }
        }
        
        function stopCollection() {
            if (isCollecting) {
                isCollecting = false;
                addLog('‚èπÔ∏è Coleta interrompida pelo usu√°rio');
                alert('‚èπÔ∏è Coleta interrompida! Os dados coletados foram salvos.');
            }
        }
        
        function addLog(message) {
            const logContainer = document.getElementById('collectionLog');
            const logItem = document.createElement('div');
            logItem.className = 'log-item';
            logItem.innerHTML = `<span style="color: #666;">[${new Date().toLocaleTimeString()}]</span> ${message}`;
            logContainer.appendChild(logItem);
            logContainer.scrollTop = logContainer.scrollHeight;
        }
        
        function updateResultsDisplay() {
            document.getElementById('totalEmails').textContent = collectionStats.totalEmails;
            document.getElementById('validEmails').textContent = collectionStats.validEmails;
            document.getElementById('totalCitiesResult').textContent = [...new Set(collectedData.map(item => item.city))].length;
            document.getElementById('sheetsUpdated').textContent = collectionStats.sheetsUpdated;
            
            // Mostrar emails recentes
            const recentContainer = document.getElementById('recentEmails');
            if (collectedData.length === 0) {
                recentContainer.innerHTML = '<p style="color: #666; text-align: center; padding: 20px;">Execute uma coleta para ver os resultados.</p>';
                return;
            }
            
            const recentEmails = collectedData.slice(-10).reverse();
            recentContainer.innerHTML = recentEmails.map(item => `
                <div class="email-item">
                    <div>
                        <strong>${item.name}</strong><br>
                        <span style="color: #28a745;">üìß ${item.email}</span><br>
                        <small style="color: #666;">üìû ${item.phone} | üèôÔ∏è ${item.city} | üîç ${item.source}</small>
                    </div>
                    <div style="text-align: right;">
                        <span style="background: ${item.verified ? '#28a745' : '#ffc107'}; color: white; padding: 5px 10px; border-radius: 15px; font-size: 12px;">
                            ${item.verified ? '‚úÖ Verificado' : '‚ùì Pendente'}
                        </span>
                    </div>
                </div>
            `).join('');
            
            // An√°lise por cidade
            const cityAnalysis = document.getElementById('cityAnalysis');
            const cityCount = {};
            collectedData.forEach(item => {
                cityCount[item.city] = (cityCount[item.city] || 0) + 1;
            });
            
            const sortedCities = Object.entries(cityCount)
                .sort(([,a], [,b]) => b - a)
                .slice(0, 5);
            
            cityAnalysis.innerHTML = sortedCities.map(([city, count]) => `
                <div style="display: flex; justify-content: space-between; padding: 10px; background: #f8f9fa; border-radius: 5px; margin: 5px 0;">
                    <span><strong>${city}</strong></span>
                    <span style="color: #28a745; font-weight: bold;">${count} emails</span>
                </div>
            `).join('');
        }
        
        function updateSheetsDisplay() {
            const sheetStatus = document.getElementById('sheetStatus');
            
            if (!apiKeys.google || !apiKeys.spreadsheetId) {
                sheetStatus.innerHTML = '<p style="color: #dc3545; text-align: center;">‚ùå APIs do Google n√£o configuradas</p>';
                return;
            }
            
            sheetStatus.innerHTML = `
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <div>
                        <strong>üìä Planilha ID:</strong><br>
                        <code style="background: #e9ecef; padding: 5px; border-radius: 3px; font-size: 12px;">${apiKeys.spreadsheetId}</code>
                    </div>
                    <div>
                        <strong>üíæ Registros Salvos:</strong><br>
                        <span style="font-size: 1.5em; color: #28a745; font-weight: bold;">${collectionStats.sheetsUpdated}</span>
                    </div>
                </div>
            `;
        }
        
        async function checkSheetStatus() {
            if (!apiKeys.google || !apiKeys.spreadsheetId) {
                alert('‚ùå Configure as APIs primeiro!');
                return;
            }
            
            try {
                // Verificar informa√ß√µes da planilha
                const response = await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${apiKeys.spreadsheetId}?key=${apiKeys.google}`);
                
                if (!response.ok) {
                    throw new Error(`Erro ${response.status}: Verifique se a API Key e ID da planilha est√£o corretos`);
                }
                
                const data = await response.json();
                
                // Verificar quantas linhas j√° existem
                const valuesResponse = await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${apiKeys.spreadsheetId}/values/A:J?key=${apiKeys.google}`);
                
                let rowCount = 0;
                let hasHeaders = false;
                
                if (valuesResponse.ok) {
                    const valuesData = await valuesResponse.json();
                    if (valuesData.values) {
                        rowCount = valuesData.values.length;
                        hasHeaders = rowCount > 0 && valuesData.values[0].includes('Email');
                    }
                }
                
                const statusMessage = `‚úÖ PLANILHA CONECTADA COM SUCESSO!
                
üìä Nome: ${data.properties.title}
üìã Abas: ${data.sheets.length}
üìù Linhas com dados: ${rowCount}
üè∑Ô∏è Cabe√ßalhos: ${hasHeaders ? '‚úÖ Configurados' : '‚ùå Ser√£o criados automaticamente'}
üîÑ √öltima modifica√ß√£o: ${data.properties.modifiedTime ? new Date(data.properties.modifiedTime).toLocaleString('pt-BR') : 'N/A'}

${rowCount === 0 ? 'üí° A planilha est√° vazia - perfeito para come√ßar!' : `üìä J√° existem ${rowCount} linhas de dados`}`;
                
                alert(statusMessage);
                
                // Atualizar display
                updateSheetsDisplay();
                
            } catch (error) {
                const errorMessage = `‚ùå ERRO NA CONEX√ÉO COM A PLANILHA!

üîç Poss√≠veis causas:
‚Ä¢ API Key incorreta ou sem permiss√µes
‚Ä¢ ID da planilha incorreto
‚Ä¢ Planilha n√£o existe ou n√£o √© acess√≠vel
‚Ä¢ Google Sheets API n√£o habilitada

üìù Erro t√©cnico: ${error.message}

üí° Dica: Verifique se copiou apenas o ID da planilha (sem a URL completa)`;
                
                alert(errorMessage);
                console.error('Erro detalhado:', error);
            }
        }
        
        async function createNewSheet() {
            if (!apiKeys.google) {
                alert('‚ùå Configure a API Key do Google primeiro!');
                return;
            }
            
            try {
                // Simular cria√ß√£o de nova planilha
                const sheetName = `Emails Coletados - ${new Date().toLocaleDateString()}`;
                
                alert(`‚úÖ Nova planilha criada!\n\nüìä Nome: ${sheetName}\nüîó Configure o ID da nova planilha nas configura√ß√µes`);
                
            } catch (error) {
                alert('‚ùå Erro ao criar planilha: ' + error.message);
            }
        }
        
        // Fun√ß√µes auxiliares para APIs reais
        async function findDomainsForKeyword(keyword, city) {
            // Simular busca de dom√≠nios
            const domains = [
                `${keyword.replace(/\s+/g, '')}.com.br`,
                `${keyword.replace(/\s+/g, '')}.adv.br`,
                `${keyword.replace(/\s+/g, '')}.jus.br`
            ];
            return domains;
        }
        
        async function findCompaniesForKeyword(keyword, city) {
            // Simular busca de empresas
            return [
                `${keyword} ${city.split(',')[0]}`,
                `Escrit√≥rio de ${keyword}`,
                `Consultoria ${keyword}`
            ];
        }
        
        async function findEmailsForDomain(domain) {
            // Simular busca de emails em dom√≠nio
            return [
                `contato@${domain}`,
                `comercial@${domain}`,
                `atendimento@${domain}`
            ];
        }
        
        // Inicializa√ß√£o
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ Sistema de Coleta Autom√°tica carregado!');
            console.log('üéØ M√©todo: APIs gratuitas + Google Sheets/Drive');
            console.log('üë®‚Äçüíº Cliente: Mois√©s Perito Grafot√©cnico');
            
            loadSavedConfig();
            
            // Selecionar m√©todo h√≠brido por padr√£o
            document.getElementById('method-hybrid').classList.add('selected');
            
            console.log('‚úÖ Sistema pronto para coleta autom√°tica!');
        });
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'97254dbca097f241',t:'MTc1NTcyODY5NS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>



